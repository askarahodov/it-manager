# ADR 0002: Расписания Automation (MVP) в `Playbook.variables`

## Статус

Принято (MVP).

## Контекст

Нужно поддержать запуск плейбуков по расписанию (cron/interval) при текущей архитектуре и без поломки существующей БД, где миграции Alembic ещё не введены в эксплуатацию.

## Решение (MVP)

- Конфигурация расписания хранится в `playbooks.variables.__schedule` (JSON).
- Воркер периодически опрашивает `/api/v1/playbooks/`, вычисляет "due" и создаёт запуск через `/api/v1/playbooks/{id}/run`.
- Для защиты от дублей используется Redis lock `itmgr:schedule:lock:{playbook_id}:{due_key}`.
- Для UI `schedule` отдаётся отдельным полем в Playbook схемах, извлекается из `variables.__schedule` на backend.

## Связанные решения

- ADR 0003: Исполнение Ansible через `ansible-runner` в воркере.

## Последствия

Плюсы:
- Не требуется изменение схемы БД прямо сейчас.
- Расписания доступны сразу и работают в docker-compose.

Минусы:
- Конфиг расписаний смешан с `variables`.
- Нет индексации/SQL-фильтрации "due" задач.
- Часть логики расписаний живёт в воркере.

## План миграции (целевая архитектура)

После внедрения Alembic:
- Вынести расписания в отдельную таблицу/колонки (`enabled`, `type`, `expr/value`, `targets`, `last_run_at`, `next_run_at`).
- Перенести расчёт `next_run_at` в backend (или в воркер с записью в БД).
- Перенести данные из `variables.__schedule` в новую структуру миграцией, затем очистить `__schedule`.
