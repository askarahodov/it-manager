# ADR 0003: Исполнение Ansible через ansible-runner в воркере

## Статус

Принято.

## Контекст

Нужно запускать Ansible из отдельного контейнера-воркера, обеспечивая:

- изоляцию выполнения (не в API контейнере)
- потоковый лог (live) в UI
- контроль таймаутов/ретраев
- аккуратную работу с секретами (минимум “следов” на диске)

Ранее использовался прямой запуск `ansible-playbook` через `subprocess`, с чтением stdout построчно.

## Решение

- В воркере добавлен `ansible-runner` и запуск плейбуков выполняется через `ansible_runner.interface.run_async`.
- Логи событий (`event.stdout`) собираются в очередь и стримятся в backend (`/runs/:id/append-log`) + пишутся в `run.log`.
- `extra_vars` передаются в runner как `extravars` (в памяти), а не как файл.
- Артефакты runner (`/var/ansible/runs/:id/runner`) удаляются по умолчанию, чтобы не оставлять потенциально чувствительные данные.
- Для совместимости предусмотрен fallback на прямой `ansible-playbook` при ошибках runner.

## Настройки

- `WORKER_USE_ANSIBLE_RUNNER=1|0` (по умолчанию `1`)
- `WORKER_KEEP_SENSITIVE_ARTIFACTS=true` — не удалять чувствительные файлы (только для отладки, не для prod)

## Последствия

Плюсы:
- единая “правильная” точка интеграции с Ansible (runner)
- стабильный event stream для live-логов
- меньше потребность писать `extra_vars` на диск

Минусы:
- немного усложняется воркер и его зависимости
- event stream зависит от формата событий runner (нужно поддерживать совместимость версий)

